#!/bin/sh -f

# This is a shell wrapper for the MathQuiz conversion programs. We
# first run htlatex on $quizfile=$x, and then use mathquiz.py to
# convert the xml produced into html. Finally, we move all images
# files into a subdirectory, called $quizfile, and remove all
# extraneous files.
#                                         Andrew Mathas, 20/1/2004

# Location of configuration files
MathQuizSRC="/users/pmstaff/mathas/Courses/MathQuiz/python"

usage() {
  cat <<EndOfUsage 
MATHQUIZ(1)               SMS Manual Page

  mathquiz - convert latex file which uses mathquiz.cls into an 
             HTML based quiz 

SYNOPSIS
  mathquiz [-f] [-x] file

DESCRIPTION
  MathQuiz is a system for writing interactive web quizzes. It
  uses tex4ht together with some python scripts to convert a
  latex file, which uses the mathquiz.cls class file, into an
  interactive web based quiz.
  
  For documentation on using the mathquiz.cls class file see:
    http://rome:8000/u/mathas/loc/mathquiz/mathquiz-manual.html

  MathQuiz is maintained by Andrew Mathas so any queries should
  be directed to him at mathas@maths.usyd.edu.au. Please contact
  him with any queries about mathquiz.

OPTIONS
  Both options are for debugging and are not intended for general
  use.
      -f   Process only the xml file (and do not run htlatex).
           This option. This is only useful if mathquiz was last
           run using the -x option (otherwise, there is no xml
           file to process).
      -x   Do not delete the xml file.

AUTHOR
  Andrew Mathas

Version 4.2                                           April 2004

EndOfUsage
exit 
}

# option defaults
runhtlatex=1
deletexmlfile=1
mathquiz="mathquiz.py"
htoptions=""

# parse arguments
set -- `getopt --quiet --unquoted xf $*`
test $? -ne 0 && ( usage; exit )

while [ $1 != -- ]
do
  case $1 in
    -f) runhtlatex=0 
        deletexmlfile=0 ;;
    -x) deletexmlfile=0 ;;
    -*) usage && exit   ;;
  esac
  shift
done
shift # move past the "--" returned by getopt

# check number of arguments and exit if necessary
test $# -ne 1 && usage 

# remove extension from $1
quizfile="`echo $1 | sed 's@\..*@@'`"

# check that quiz file exists
test ! -r "$quizfile.tex" \
  && echo "  MathQuiz: File $quizfile.tex not found" && exit 1

# set file permissions for any files that we create
umask 022

# Test that tex file exists and create quizfile subdirectory if needed
test ! -r $quizfile.tex && echo "$quizfile.tex not found !!" && exit 1

# remove old html file
/bin/rm -f $quizfile.html

if test $runhtlatex -eq 0 ; then

  # skip htlatex
  echo "Converting to html"
  python2.2  $MathQuizSRC/$MathQuiz $quizfile.xml > $quizfile.html

else
  # remove old image files
  test -e $quizfile && /bin/rm -Rf $quizfile
  test ! -e $quizfile && mkdir $quizfile

  echo "Running htlatex..."
  htlatex $quizfile $MathQuizSRC/mathquiz $htoptions

  echo "Converting to html"
  python2.2  $MathQuizSRC/$MathQuiz $quizfile.xml > $quizfile.html

  test $? -ne 0 && echo "ERROR: MathQuiz returned an error?!" && exit $?

  # Now move all of the image files into the directory $quizfile -
  # This should be done by tex4ht??? The bonus is that we remove the
  # $quizfile directory if there are no images.
  if test $runhtlatex -eq 1; then 
    echo "moving images files"
    gawk -F\/ -v quizfile="$quizfile" \
         'BEGIN{str="src=\"" quizfile; moved["fred"]=0 ; images=0 } 
          ($1 == str) { file=substr($2,1, index($2,"\"")-1) 
                        if ( ! (file in moved) ) {
                          images+=1
                          moved[ file ]=1
                          cmd="/bin/mv " file " " quizfile "/" file 
  		        system( cmd ) 
  		        close ( cmd )
  		    } 
          }
          END{ if (images==0) system("/bin/rmdir " quizfile ) 
          }' $quizfile.xml
  fi
fi

# Remove everything but the original tex file, and the html and css files
/bin/rm -f $quizfile.{aux,4ct,dvi,idv,log,4tc,lg,tmp,xref}

test $deletexmlfile -eq 1 && /bin/rm $quizfile.xml

echo
echo "Please contact Andrew Mathas with any queries about mathquiz."

