% -----------------------------------------------------------------------
%   webquiz.cfg | webquiz TeX4ht configuration file
% -----------------------------------------------------------------------
%
%   Copyright (C) Andrew Mathas and Don Taylor, University of Sydney
%
%   Distributed under the terms of the GNU General Public License (GPL)
%               http://www.gnu.org/licenses/
%
%   This file is part of the WebQuiz system.
%
%   <Andrew.Mathas@sydney.edu.au>
%   <Donald.Taylor@sydney.edu.au>
% ----------------------------------------------------------------------

\NeedsTeXFormat{LaTeX2e}[1996/12/01]
\ProvidesFile{webquiz.cfg}[2019/01 v5.0 tex4ht configuration file for WebQuiz]
\makeatletter

% Generate HTML5 + MathML code
\Preamble{xhtml,mathml,html5,NoFonts,charset="utf-8",ext=xml}

% Don't output xml version tag
\Configure{VERSION}{}

% Output a WebQuiz doctype instead of the default for HTML5
\Configure{DOCTYPE}{\HCode{<?xml version="1.0" encoding="UTF-8" standalone="no"?>\Hnewline<!DOCTYPE webquiz SYSTEM "webquiz.dtd">}}

\newcommand\HNewLine{\HCode{\Hnewline}}
% store the quiz specifications as attributes to <quiz>
\Configure{HTML}{%
  \HNewLine%
  \Tg<webquiz hide_side_menu="\latexquizOption{hidesidemenu value}"
              language="\latexquizOption{language}"
              one_page="\latexquizOption{onepage value}"
              pst2pdf="\latexquizOption{pst2pdf value}"
              random_order="\latexquizOption{randomorder value}"
              src="\jobname.tex"
              theme="\latexquizOption{theme}">
  \HNewLine%
  \Tg<title>\@title\Tg</title>%
  \HNewLine%
  \Tg<breadcrumb breadcrumbs="\MQ@breadcrumbs">\MQ@breadcrumb\Tg</breadcrumb>%
  \HNewLine%
  \Tg<unit_name url="\uos@url" quizzes_url="\MQ@quizzesUrl">\uos@name\Tg</unit_name>%
  \HNewLine%
  \Tg<unit_code>\uos@code\Tg</unit_code>%
  \HNewLine%
  \Tg<department url="\MQ@departmentURL">\MQ@department\Tg</department>%
  \HNewLine%
  \Tg<institution url="\MQ@institutionURL">\MQ@institution\Tg</institution>%
  \HNewLine%
}{\Tg</webquiz>}

% reset all configurations
\Configure{HEAD}{}{}
\Configure{BODY}{}{}
\Configure{TITLE}{}{}
\Configure{TITLE+}{}
\Configure{thanks author date and}{}{}{}{}{}{}{}{}
\renewcommand{\maketitle}{}

% pstricks pictures need to be converted to svg images
\ConfigureEnv{psmatrix}{\Picture*{}}{\EndPicture}{}{}
\Configure{Picture}{.svg}

%\Configure{textit}{\HCode{<span class="textit">}\NoFonts}{\EndNoFonts\HCode{</span>}}
%\Configure{textsf}{\HCode{<span class="textsf">}\NoFonts}{\EndNoFonts\HCode{</span>}}

\def\MQ@openText{\Tg<text>\HtmlParOff\HCode{<![CDATA[}}
\def\MQ@closeText{\HCode{]]>}\HtmlParOn\Tg</text>}
\def\MQ@closeResponse{\HCode{]]>}\HtmlParOn\Tg</response>}
\def\MQ@closeItem{\MQ@closeText\Tg</item>}
\let\MQ@closeOption=\relax
\ConfigureEnv{quizindex}{\HCode{<quizindex>}}{\HCode{</quizindex>}}{}{}
\renewcommand{\quiz}[2][\relax]{%
  \refstepcounter{quiz}
  \ifx#1\relax\def\MQ@url{quiz\thequiz.html}%
  \else\def\MQ@url{#1}%
  \fi%
  \Tg<index_item url="\MQ@url">\MQ@openText Quiz \thequiz.\space#2\MQ@closeText\Tg</index_item>}
\RenewDocumentEnvironment{discussion}{O{Discussion}O{Discussion}}%
    {\Tg<discussion>
    \Tg<short_heading>#1\Tg</short_heading>
    \Tg<heading>#2\Tg</heading>
     \Tg<text>\HCode{<![CDATA[\Hnewline}}
    {\EndP\HCode{\Hnewline]]>}\Tg</text>\HNewLine\Tg</discussion>}
\renewenvironment{question}{%
  \refstepcounter{question}%
  \IgnorePar\HCode{\Hnewline<question>\Hnewline}%
  \let\MQ@closeQuestion=\relax%
  \MQ@openText}%
  {\MQ@closeOption\MQ@closeQuestion\Tg</question>%
  \let\MQ@closeOption=\relax}

\RenewDocumentEnvironment{choice}{O{}}{%
  % process the environment options
  \setcounter{choice}{0}%
  \typeout{checking #1...}
  \pgfkeys{/webquiz checker, #1}%
  \typeout{checked #1...}
  % now insert tex4ht code
  \MQ@closeText%
  \IgnorePar%
  \Tg<choice type="\pgfkeysvalueof{/webquiz checker/mode}" columns="\pgfkeysvalueof{/webquiz checker/columns value}">%
  \let\MQ@closeOption=\relax}%
  {\MQ@closeOption\Tg</choice>}
\def\MQ@item#1{\MQ@closeOption\HNewLine\refstepcounter{choice}%
  \Tg<item correct="#1" symbol="\thechoice">\MQ@openText%
  \let\MQ@closeOption=\MQ@closeItem%
}
\def\correct{\MQ@item{true}}
\def\incorrect{\MQ@item{false}}
\renewcommand{\response}{\MQ@closeOption
  \Tg<response>\HtmlParOff\HCode{<![CDATA[}%
  \let\MQ@closeOption=\MQ@closeResponse}
\renewcommand{\answer}[2][string]{%
  \MQ@closeText%
  \pgfkeys{/webquiz checker/comparison/#1}%
  \HNewLine%
  \Tg<answer comparison="#1">\HCode{<![CDATA[}#2\HCode{]]>}\Tg</answer>%
  \let\MQ@closeQuestion=\relax%
  \let\MQ@closeOption=\MQ@closeText%
  \HNewLine%
  \MQ@openText%
}
\newcommand\MQ@when[1]{\MQ@closeOption%
  \def\MQ@closeOption{\HCode{]]>}\Tg</when_#1>}\HNewLine%
  \IgnorePar\Tg<when_#1>\HCode{<![CDATA[}%
}
\renewcommand\whenRight{\MQ@when{right}}
\renewcommand\whenWrong{\MQ@when{wrong}}

% from https://tex.stackexchange.com/questions/225554/syntax-highlighting-in-an-html-presentation
% extract current color as hexadecimal value
\makeatletter
\ifdefined\lst@version
  \newcommand\tsf@getColor[1][.]{
      % colorname `.` holds current color
      \extractcolorspec{.}{\tsf@color}
      \expandafter\convertcolorspec\tsf@color{HTML}\tsf@color
      %\tmpcolor
  }

  % write css color for given css selector
  \newcommand\CssColor[1]{%
      % save current color
      \tsf@getColor%
      \Css{#1{color:\#\tsf@color;}}%
  }
\fi

% Do not set `indent`/`noindent` classes on paragraphs
\Configure{HtmlPar}
    {\EndP\Tg<p>}
    {\EndP\Tg<p>}
    {\HCode{</p>\Hnewline}}
    {\HCode{</p>\Hnewline}}

\RequirePackage{etoolbox}
\renewcommand\DisplayAsImage[2][]{%
  \csletcs{real:#2}{#2}%
  \NewConfigure{#2}{2}
  \csdef{#2}##1{\Picture+[#1]{}\csuse{real:#2}{##1}\EndPicture}
  \Configure{#2}{\Picture+[#1]{}}{\EndPicture}
}

\begin{document}

% disable \title after \begin{document}
\def\title{\MQ@error{\@backslashchar title can only be used in the preamble}\@ehc}

\ifdefined\lst@version
  % from https://www.mail-archive.com/tex4ht@tug.org/msg00116.html
  \let\savecolor\color
  \NewConfigure{color}[2]{\def\a@color{#1}\def\b@color{#2}}
  \def\@@tmp#1{\a@color#1\b@color\savecolor{#1}\aftergroup\endspan}
  \let\color\@@tmp
  \def\endspan{\Tg</span>}
  \Configure{color}{\HCode{<span style="color:}}{\HCode{">}}

  \ConfigureEnv{lstlisting}
     {\let\color\savecolor
      \ifvmode \IgnorePar\fi \EndP
      \gHAdvance\listingN by 1
      \HCode{<!--l. \the\inputlineno-->}%
      \gdef\start:LstLn{\HCode{<div class="lstlisting" id="listing-\listingN">}%
        \gdef\start:LstLn{\leavevmode\special{t4ht@+\string&{35}x00A0{59}}x%
      \HCode{<br/>}}}
      \bgroup
         \Configure{listings}
           {{\everypar{}\leavevmode}}
           {{\everypar{}\leavevmode}}
           {\start:LstLn \HCode{<span class="label">}}
           {\HCode{</span>}}%
     }
     {\egroup
      \ifvmode \IgnorePar\fi \EndP \HCode{</div>}\par}
     {}{}

  % for listings in webquiz-manual
  % from https://tex.stackexchange.com/questions/225554/syntax-highlighting-in-an-html-presentation
  \newcommand\LstCss[2]{%
      \bgroup%
          \csname lst@#2\endcsname%
          \CssColor{#1}%
      \egroup%
  }

  \LstCss{div.lstlisting .ecbx-1000}{keywordstyle}
  \LstCss{div.lstlisting .ecss-1000}{commentstyle}
  \LstCss{div.lstlisting .ectt-1000}{basicstyle}
\fi

\makeatother

\EndPreamble

%  bug fix for \mathbf from http://tex.stackexchange.com/questions/362178
\Configure{mathbf}{\HCode{<mi  mathvariant="bold">}\PauseMathClass}{\EndPauseMathClass\HCode{</mi>}}

%\ifTikz
%    \tikzset{every node/.style={/pgf/tex4ht node/escape=true}}
%\fi

\endinput
%%
%% End of file `webquiz.cfg'.
